#!/usr/bin/env bash

set -e # Exit on error
set -u # Exit on unset variables

# Parse arguments to detect flags
enable_helm=false
positional_args=()

for arg in "$@"; do
    if [ "$arg" = "--enable-helm" ]; then
        enable_helm=true
    elif [ "$arg" = "-h" ] || [ "$arg" = "--help" ]; then
        cat <<EOF
Usage: $0 [OPTIONS] [directory] [recursive]
  directory       (optional) Directory in which to search for Kustomization files (default: overlays)
  recursive       (optional) "true", "false", or "--no-recurse" (default: true).
                  When set to "false" or "--no-recurse", find is called with "--maxdepth 1".

OPTIONS:
  --enable-helm    Enable Helm chart inflation during kustomize build (requires helm to be installed)
  --no-recurse     Disable recursive search (alternative to "false")
  -h, --help       Display this help message
EOF
        exit 0
    else
        positional_args+=("$arg")
    fi
done

# Check if kustomize is available
if ! command -v kustomize >/dev/null 2>&1; then
    printf "\033[0;31mâŒ kustomize command not found. Please install kustomize.\033[0m\n" >&2
    exit 1
fi

# Set parameters from positional arguments
source_dir="${positional_args[0]:-overlays}"
recursive="${positional_args[1]:-true}"

# Normalize recursive parameter - accept --no-recurse as "false"
if [ "$recursive" = "--no-recurse" ]; then
    recursive="false"
fi

# Check if helm is available when --enable-helm is set
if [ "$enable_helm" = true ]; then
    if ! command -v helm >/dev/null 2>&1; then
        printf "\033[0;31mâŒ helm command not found. Please install helm or remove --enable-helm flag.\033[0m\n" >&2
        exit 1
    fi
fi

printf "ðŸ” Searching in directory: %s (recursive: %s, helm: %s)\n" "$source_dir" "$recursive" "$enable_helm"

# Check if the directory exists
if [ ! -d "$source_dir" ]; then
    printf "\033[0;31mâŒ Directory '%s' does not exist.\033[0m\n" "$source_dir" >&2
    exit 1
fi

# Validate the recursive parameter
if [ "$recursive" != "true" ] && [ "$recursive" != "false" ]; then
    printf "\033[0;31mâŒ Invalid value for recursive: %s. Please use 'true' or 'false'.\033[0m\n" "$recursive" >&2
    exit 1
fi

# Function to validate a Kustomization file
validate_kustomization() {
    local kustomize_file dir kustomize_cmd
    kustomize_file="$1"
    dir=$(dirname "$kustomize_file")

    # Build kustomize command with optional --enable-helm flag
    if [ "$enable_helm" = true ]; then
        kustomize_cmd="kustomize build --enable-helm"
    else
        kustomize_cmd="kustomize build"
    fi

    if $kustomize_cmd "$dir" >/dev/null 2>&1; then
        printf "âœ… %s\n" "$kustomize_file"
    else
        printf "\n\033[0;31mâŒ Error\033[0m in file: %s\n" "$kustomize_file" >&2
        return 1
    fi
}

# Search and validate Kustomization files
if [ "$recursive" = "false" ]; then
    find "$source_dir" -maxdepth 1 -type f \( \
        -name "kustomization.yaml" -o \
        -name "kustomization.yml" -o \
        -name "Kustomization" \
        \) | while IFS= read -r file; do
        validate_kustomization "$file" || exit 1
    done
else
    find "$source_dir" -type f \( \
        -name "kustomization.yaml" -o \
        -name "kustomization.yml" -o \
        -name "Kustomization" \
        \) | while IFS= read -r file; do
        validate_kustomization "$file" || exit 1
    done
fi
